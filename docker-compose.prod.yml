version: '3.8'

services:
  # -------------------------------------------------------------------------
  # API Gateway (Public-facing)
  # -------------------------------------------------------------------------
  # -------------------------------------------------------------------------
  # Reverse Proxy (HTTPS Termination)
  # -------------------------------------------------------------------------
  caddy:
    image: caddy:2-alpine
    container_name: personalize_caddy
    restart: always
    env_file:
      - .env.prod
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
      - caddy_config:/config
    networks:
      - backend-network
    depends_on:
      - gateway

  # -------------------------------------------------------------------------
  # API Gateway (Internal)
  # -------------------------------------------------------------------------
  gateway:
    build:
      context: .
      dockerfile: apps/personalize-api/Dockerfile
    container_name: personalize_gateway
    restart: always
    env_file:
      - .env.prod
    # Ports removed: Caddy handles ingress
    expose:
      - "3000"
    environment:
      # Database
      DATABASE_HOST: postgres_prod # or the Oracle DB IP
      DATABASE_PORT: 5432
      DATABASE_USER: ${POSTGRES_USER}
      DATABASE_PASSWORD: ${POSTGRES_PASSWORD}
      DATABASE_NAME: ${POSTGRES_DB}
      # JWT
      JWT_SECRET: ${JWT_SECRET}
      # Microservices
      POST_SERVICE_HOST: post-service
      POST_SERVICE_PORT: 3001
      NOTIFICATIONS_SERVICE_HOST: notifications-service
      NOTIFICATIONS_SERVICE_PORT: 3002
      FILE_SERVICE_HOST: file-service
      FILE_SERVICE_PORT: 3003
      # Redis
      REDIS_HOST: redis_prod
      REDIS_PORT: 6379
      # Others
      NODE_ENV: production
    depends_on:
      - postgres_prod
      - redis_prod
      - post-service
      - notifications-service
      - file-service
    networks:
      - backend-network

  # -------------------------------------------------------------------------
  # Microservices (Private Network)
  # -------------------------------------------------------------------------
  post-service:
    build:
      context: .
      dockerfile: apps/post-service/Dockerfile
    container_name: personalize_post_service
    restart: always
    env_file:
      - .env.prod
    environment:
      DATABASE_HOST: postgres_prod
      DATABASE_PORT: 5432
      DATABASE_USER: ${POSTGRES_USER}
      DATABASE_PASSWORD: ${POSTGRES_PASSWORD}
      DATABASE_NAME: ${POSTGRES_DB}
      # Listen on internal port
      PORT: 3001
      NODE_ENV: production
    networks:
      - backend-network

  notifications-service:
    build:
      context: .
      dockerfile: apps/notifications-service/Dockerfile
    container_name: personalize_notifications_service
    restart: always
    env_file:
      - .env.prod
    environment:
      DATABASE_HOST: postgres_prod
      DATABASE_PORT: 5432
      DATABASE_USER: ${POSTGRES_USER}
      DATABASE_PASSWORD: ${POSTGRES_PASSWORD}
      DATABASE_NAME: ${POSTGRES_DB}
      PORT: 3002
      NODE_ENV: production
      # Google / Firebase
      GOOGLE_APPLICATION_CREDENTIALS: /app/firebase-service-account.json
      # OTP Fallbacks
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}
      TELEGRAM_CHAT_ID: ${TELEGRAM_CHAT_ID}
      WHATSAPP_API_URL: ${WHATSAPP_API_URL}
      WHATSAPP_PHONE_NUMBER_ID: ${WHATSAPP_PHONE_NUMBER_ID}
      WHATSAPP_ACCESS_TOKEN: ${WHATSAPP_ACCESS_TOKEN}
      WHATSAPP_TEMPLATE_NAME: ${WHATSAPP_TEMPLATE_NAME}
    volumes:
      - ./prod-personalize-firebase-adminsdk.json:/app/firebase-service-account.json:ro
    networks:
      - backend-network

  file-service:
    build:
      context: .
      dockerfile: apps/file-service/Dockerfile
    container_name: personalize_file_service
    restart: always
    env_file:
      - .env.prod
    environment:
      PORT: 3003
      NODE_ENV: production
      # MinIO / S3 Config
      AWS_REGION: us-east-1
      AWS_ACCESS_KEY_ID: ${MINIO_ROOT_USER}
      AWS_SECRET_ACCESS_KEY: ${MINIO_ROOT_PASSWORD}
      AWS_S3_BUCKET_NAME: camvolleyball-uploads
      # If using MinIO container below
      AWS_S3_ENDPOINT: http://minio_prod:9000
      AWS_S3_PUBLIC_ENDPOINT: https://files.personalize.com # Updated domain
    depends_on:
      - minio_prod
    networks:
      - backend-network

  # -------------------------------------------------------------------------
  # Infrastructure (Database & Storage)
  # -------------------------------------------------------------------------
  postgres_prod:
    image: postgres:15
    container_name: personalize_postgres_prod
    restart: always
    env_file:
      - .env.prod
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - postgres_data_prod:/var/lib/postgresql/data
    networks:
      - backend-network

  redis_prod:
    image: redis:alpine
    container_name: personalize_redis_prod
    restart: always
    command: redis-server --save 60 1 --loglevel warning
    volumes:
      - redis_data_prod:/data
    networks:
      - backend-network

  minio_prod:
    image: minio/minio
    container_name: personalize_minio_prod
    restart: always
    env_file:
      - .env.prod
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000" # API
      - "9001:9001" # Console
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    volumes:
      - minio_data_prod:/data
    networks:
      - backend-network

networks:
  backend-network:
    driver: bridge

volumes:
  postgres_data_prod:
  redis_data_prod:
  minio_data_prod:
  caddy_data:
  caddy_config:
